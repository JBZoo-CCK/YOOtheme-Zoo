/* Copyright (C) YOOtheme GmbH, http://www.gnu.org/licenses/gpl.html GNU/GPL */

(function($){var Plugin=function(){};$.extend(Plugin.prototype,{name:"autosuggest",options:{prefill:"",allowDuplicates:true,inputName:"term[]",resultsHighlight:true,addButtonText:"Add"},initialize:function(input,options){this.options=$.extend({},this.options,options);var $this=this;this.input=input;$.extend($.expr[":"],{focus:function(element){return element==document.activeElement}});input.addClass("as-input").wrap('<ul class="as-selections">').wrap('<li class="as-original">').autocomplete($.extend({select:function(event,ui){$this.addItem(ui.item);ui.item.value=ui.item.label=""}},this.options)).bind("blur",function(event){$this.selections_holder.addClass("blur").find("li.as-selection-item").removeClass("selected")}).bind("focus",function(){$this.selections_holder.removeClass("blur")}).bind("keydown",function(event){switch(event.which){case 8:if(input.val()==""){event.preventDefault();li=$("li.as-selection-item:last");li.is(".selected")?$this.removeItem(li):$this.selectItem(li)}break;case 9:event.preventDefault();$this.addItem(input.val());break}}).bind("keypress",function(event){if(event.charCode==44){event.preventDefault();$this.addItem(input.val())}});this.selections_holder=input.closest("ul.as-selections").bind("click",function(){if(input.not(":focus")){input.focus()}});this.original=this.selections_holder.find("li.as-original");$('<li class="add-tag-button" >').insertAfter(this.original).text(this.options.addButtonText).bind("click",function(){$.each(input.val().split(","),function(i,item){$this.addItem(item)})});if(typeof this.options.prefill=="string"){$.each(this.options.prefill.split(","),function(i,item){$this.addItem(item)})}else{$this.addItem(this.options.prefill)}input.is(":focus")?input.focus():input.blur();this.selections_holder.delegate("a.as-close","click",function(){$this.removeItem($(this).parent())}).delegate("li.as-selection-item","click",function(){$this.selectItem(this)})},addItem:function(item){if(typeof item=="string")item={label:item.trim(),value:item.trim()};if(item.value!=""&&(this.options.allowDuplicates||!this.itemExists(item))){var li=$('<li class="as-selection-item">').text(item.label).data("item",item).insertBefore(this.original);$('<a class="as-close">&times;</a>').appendTo(li);$('<input type="hidden" class="as-value">').attr("name",this.options.inputName).val(item.value).appendTo(li)}this.input.val("");this.input.trigger("addItem",li)},removeItem:function(li){li.remove()},itemExists:function(item){var result=false;this.selections_holder.find("li.as-selection-item").each(function(){if($(this).data("item")&&$(this).data("item").value.toLowerCase()==item.value.toLowerCase()){result=true;return}});return result},selectItem:function(li){$("li.as-selection-item",this.selections_holder).not(li).removeClass("selected");$(li).addClass("selected");if(this.input.not(":focus"))this.input.focus()}});$.fn[Plugin.prototype.name]=function(){var args=arguments;var method=args[0]?args[0]:null;return this.each(function(){var element=$(this);if(Plugin.prototype[method]&&element.data(Plugin.prototype.name)&&method!="initialize"){element.data(Plugin.prototype.name)[method].apply(element.data(Plugin.prototype.name),Array.prototype.slice.call(args,1))}else if(!method||$.isPlainObject(method)){var plugin=new Plugin;if(Plugin.prototype["initialize"]){plugin.initialize.apply(plugin,$.merge([element],args))}element.data(Plugin.prototype.name,plugin)}else{$.error("Method "+method+" does not exist on jQuery."+Plugin.name)}})}})(jQuery);