(function(e){e.widget("ui.nestedSortable",e.extend({},e.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,noJumpFix:0},_create:function(){if(this.noJumpFix==false)this.element.height(this.element.height());this.element.data("sortable",this.element.data("nestedSortable"));return e.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(t){this.position=this._generatePosition(t);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var i=this.options,s=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity)this.scrollParent[0].scrollTop=s=this.scrollParent[0].scrollTop+i.scrollSpeed;else if(t.pageY-this.overflowOffset.top<i.scrollSensitivity)this.scrollParent[0].scrollTop=s=this.scrollParent[0].scrollTop-i.scrollSpeed;if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity)this.scrollParent[0].scrollLeft=s=this.scrollParent[0].scrollLeft+i.scrollSpeed;else if(t.pageX-this.overflowOffset.left<i.scrollSensitivity)this.scrollParent[0].scrollLeft=s=this.scrollParent[0].scrollLeft-i.scrollSpeed}else{if(t.pageY-e(document).scrollTop()<i.scrollSensitivity)s=e(document).scrollTop(e(document).scrollTop()-i.scrollSpeed);else if(e(window).height()-(t.pageY-e(document).scrollTop())<i.scrollSensitivity)s=e(document).scrollTop(e(document).scrollTop()+i.scrollSpeed);if(t.pageX-e(document).scrollLeft()<i.scrollSensitivity)s=e(document).scrollLeft(e(document).scrollLeft()-i.scrollSpeed);else if(e(window).width()-(t.pageX-e(document).scrollLeft())<i.scrollSensitivity)s=e(document).scrollLeft(e(document).scrollLeft()+i.scrollSpeed)}if(s!==false&&e.ui.ddmanager&&!i.dropBehaviour)e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";for(var l=this.items.length-1;l>=0;l--){var o=this.items[l],r=o.item[0],n=this._intersectsWithPointer(o);if(!n)continue;if(r!=this.currentItem[0]&&this.placeholder[n==1?"next":"prev"]()[0]!=r&&!e.contains(this.placeholder[0],r)&&(this.options.type=="semi-dynamic"?!e.contains(this.element[0],r):true)){this.direction=n==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(o)){this._rearrange(t,o)}else{break}this._clearEmpty(r);this._trigger("change",t,this._uiHash());break}}var h=this.placeholder[0].parentNode.parentNode&&e(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?e(this.placeholder[0].parentNode.parentNode):null;var a=this._getLevel(this.placeholder);var p=this._getChildLevels(this.helper);var c=this.placeholder[0].previousSibling?e(this.placeholder[0].previousSibling):null;if(c!=null){while(c[0].nodeName.toLowerCase()!="li"||c[0]==this.currentItem[0]){if(c[0].previousSibling){c=e(c[0].previousSibling)}else{c=null;break}}}newList=document.createElement(i.listType);this.beyondMaxLevels=0;if(h!=null&&this.positionAbs.left<h.offset().left){h.after(this.placeholder[0]);this._clearEmpty(h[0]);this._trigger("change",t,this._uiHash())}else if(c!=null&&this.positionAbs.left>c.offset().left+i.tabSize){this._isAllowed(c,a+p+1);if(!c.children(i.listType).length){c[0].appendChild(newList)}c.children(i.listType)[0].appendChild(this.placeholder[0]);this._trigger("change",t,this._uiHash())}else{this._isAllowed(h,a+p)}this._contactContainers(t);if(e.ui.ddmanager)e.ui.ddmanager.drag(this,t);this._trigger("sort",t,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(t,i){if(this.beyondMaxLevels){var s=this.placeholder.parent().closest(this.options.items);for(var l=this.beyondMaxLevels-1;l>0;l--){s=s.parent().closest(this.options.items)}this.placeholder.removeClass(this.options.errorClass);s.after(this.placeholder);this._trigger("change",t,this._uiHash())}e.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(t){var i=this._getItemsAsjQuery(t&&t.connected);var s=[];t=t||{};e(i).each(function(){var i=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);var l=(e(t.item||this).parent(t.listType).parent("li").attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);if(i)s.push((t.key||i[1]+"["+(t.key&&t.expression?i[1]:i[2])+"]")+"="+(l?t.key&&t.expression?l[1]:l[2]:"root"))});if(!s.length&&t.key){s.push(t.key+"=")}return s.join("&")},toHierarchy:function(t){t=t||{};var i=t.startDepthCount||0;var s=[];e(this.element).children("li").each(function(){var t=l(e(this));s.push(t)});return s;function l(i){var s=(e(i).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);if(s!=null){var o={id:s[2]};if(e(i).children(t.listType).children("li").length>0){o.children=[];e(i).children(t.listType).children("li").each(function(){var t=l(e(this));o.children.push(t)})}return o}}},toArray:function(t){t=t||{};var i=t.startDepthCount||0;var s=[];var l=2;s.push({item_id:"root",parent_id:"none",depth:i,left:"1",right:(e("li",this.element).length+1)*2});e(this.element).children("li").each(function(){l=r(this,i+1,l)});function o(e,t){return e["left"]-t["left"]}s=s.sort(o);return s;function r(l,o,n){right=n+1;if(e(l).children(t.listType).children("li").length>0){o++;e(l).children(t.listType).children("li").each(function(){right=r(e(this),o,right)});o--}id=e(l).attr(t.attribute||"id").match(t.expression||/(.+)[-=_](.+)/);if(o===i+1)pid="root";else{parentItem=e(l).parent(t.listType).parent("li").attr("id").match(t.expression||/(.+)[-=_](.+)/);pid=parentItem[2]}if(id!=null){s.push({item_id:id[2],parent_id:pid,depth:o,left:n,right:right})}return n=right+1}},_clear:function(t,i){e.ui.sortable.prototype._clear.apply(this,arguments);for(var s=this.items.length-1;s>=0;s--){var l=this.items[s].item[0];this._clearEmpty(l)}return true},_clearEmpty:function(e){if(e.children[1]&&e.children[1].children.length==0){e.removeChild(e.children[1])}},_getLevel:function(e){var t=1;if(this.options.listType){var i=e.closest(this.options.listType);while(!i.is(".ui-sortable")){t++;i=i.parent().closest(this.options.listType)}}return t},_getChildLevels:function(t,i){var s=this,l=this.options,o=0;i=i||0;e(t).children(l.listType).children(l.items).each(function(e,t){o=Math.max(s._getChildLevels(t,i+1),o)});return i?o+1:o},_isAllowed:function(e,t){var i=this.options;if(e==null||!e.hasClass(i.disableNesting)){if(i.maxLevels<t&&i.maxLevels!=0){this.placeholder.addClass(i.errorClass);this.beyondMaxLevels=t-i.maxLevels}else{this.placeholder.removeClass(i.errorClass);this.beyondMaxLevels=0}}else{this.placeholder.addClass(i.errorClass);if(i.maxLevels<t&&i.maxLevels!=0){this.beyondMaxLevels=t-i.maxLevels}else{this.beyondMaxLevels=1}}}}));e.ui.nestedSortable.prototype.options=e.extend({},e.ui.sortable.prototype.options,e.ui.nestedSortable.prototype.options)})(jQuery);